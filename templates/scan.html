<html>
<head>
<script src="https://code.jquery.com/jquery-3.3.1.min.js" type="text/javascript"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" type="text/javascript"></script>
</head>

<body>
<div class="col-md-12">

    <select id="video-select" class="form-control">

    </select>

    <video id="video" autoplay="autoplay" controls="controls"></video>
    <hr />
    <button class="btn btn-danger" id="stream">Scan</button>
    <button class="btn btn-primary" id="stop">Stop</button>
    <hr />
    <canvas id="image" class="hidden"></canvas>
    <button type="button" class="btn btn-info" data-toggle="modal" data-target="#add-popup">Open</button>
</div>



<script type="text/javascript">
    // Setup variables
    navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia
    var videoStream = null
    var video = document.getElementById('video');
    var createSrc = window.URL ? window.URL.createObjectURL : function(stream) {return stream;};
    var device = null
    var timer = null
    var interval = 100
    var playing = false

    // setup functions
    function startVideo(){
        playing = true
        vidSource = jQuery('#video-select').val()
        console.log('Video source selected: ' + vidSource)
        navigator.getUserMedia(
            {video: { deviceId: vidSource }},
            function(stream) {
                videoStream = stream
                video.src = createSrc(stream);
                video.play();
            },
            function(err){
                console.log('Something went wrong : ', err.code)
            });
    };

    function stopVideo(){
        video.pause();
        var tracks = videoStream.getTracks()
        tracks.forEach(function(track){
            track.stop();
        });
        video.src = '';
        playing = false
    };

    function snapshot(){
        var canvas = document.getElementById('image');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0,0)
    };

    function sendImg(){
        var imgdata = document.getElementById('image').toDataURL("img/png");
        imgdata = imgdata.replace('data:image/png;base64,','');

        data = {
            'imgdata': imgdata,
            'encoding' : 'base64',
            'format': 'image/png'
        };
        jQuery.ajax({
            url: '/scan/ajax_process/',
            type: 'POST',
            data: data,
            dataType: "json",
            success: function(resp){
                // print to console
                if (resp.hits > 0){
                    jQuery.each(resp.data, function(index, datum){
                        console.log(index + ': ' + datum.type + ' - ' + datum.value)
                    })
                    jQuery('#add-popup').modal('show');
                    // prefill modal
                    searchISBN(resp.data[0].type, resp.data[0].value);
                }
            }
        });
    };

    function searchISBN(type, isbn){
        jQuery.ajax({
            url: '/scan/ajax_bookdata/',
            type: 'POST',
            data: {'key' : isbn, 'type': type},
            dataType: 'json',
            success: prefillData
        });
    };

    function clearData(){
        jQuery('#title').val('');
        jQuery('#author_name').val('');
        jQuery('#author_id').val('');
        jQuery('#publisher').val('');
        jQuery('#language').val('');
        jQuery('#isbn10').val('');
        jQuery('#isbn13').val('');
        jQuery('#summary').val('');
        jQuery('#publish_date').val('');
        jQuery('#series_name').val('');
        jQuery('#series_id').val(-1);
        jQuery('input:radio[name=is_series]')[0].checked = false;
        jQuery('input:radio[name=is_series]')[1].checked = true;
        hideSeries();
    }

    function prefillData(data){
        console.log(data);
        jQuery('#title').val(data.title);
        if (data.author != null) {
            jQuery('#author_id').val(data.author.id);
            jQuery('#author_name').val(data.author.name);
        } else {
            jQuery('#author_name').val(data.author_name);
        }
        jQuery('#publisher').val(data.publisher);
        jQuery('#language').val(data.language);
        jQuery('#isbn10').val(data.isbn10);
        jQuery('#isbn13').val(data.isbn13);
        jQuery('#summary').val(data.summary);
        jQuery('#publish_date').val(data.publish_date)
    }

    function videoSources(){
        navigator.mediaDevices.enumerateDevices().then(function(devices){
            devices.forEach(function(source){

                var vidSelect = jQuery('#video-select')
                if (source.kind == 'videoinput') {
                    // only add video inputs to the selector
                    console.log(source.kind + ': ' + source.label + ' (' + source.deviceId + ')');
                    vidSelect.append(jQuery('<option>', {
                        value: source.deviceId,
                        text: source.label
                    }));
                }
            });
        });
    };


    function startStream(){
        startVideo();
        setTimeout(function() {
            timer = setInterval(function(){
                snapshot();
                sendImg();
            }, interval);
        }, 1000);
    };

    function stopStream(){
        clearInterval(timer)
    };

    jQuery(document).ready(function(){
        videoSources()
        jQuery('#add-popup').on('hide.bs.modal', function (evt) {
            if (playing) {
                startStream();
                video.play();
            }
          });

        jQuery('#add-popup').on('show.bs.modal', function (evt) {
              clearData();
              stopStream();
              video.pause();
          });

        jQuery('#play').on('click', startVideo);
        jQuery('#stop').on('click', stopVideo);
        jQuery('#stop').on('click', stopStream);
        jQuery('#snap').on('click', snapshot);
        jQuery('#share').on('click', sendImg);
        jQuery('#stream').on('click', startStream);
    });

</script>
<script type="text/javascript">
    function setIdentifier(el,id){
        jQuery('#'+ el + '_id').val(id);
    };

    function hideSeries(){
        jQuery('#series_nr_field').hide();
        jQuery('#series_name_field').hide();
    };

    function showSeries(){
        jQuery('#series_nr_field').show();
        jQuery('#series_name_field').show();
    };

    function toggleSeries(){
        jQuery(':radio').change(function (event) {
            var id = jQuery(this).data('id');
            if (id == 'is_series_yes') {
                showSeries();
            } else if (id == 'is_series_no') {
                hideSeries();
            }
        });
    };

   function saveBook(){
        var data = {
            'title' : jQuery('#title').val(),
            'authors.name' : jQuery('#author_name').val(),
            'author_id' : jQuery('#author_id').val(),
            'publisher' : jQuery('#publisher').val(),
            'language' : jQuery('#language').val(),
            'isbn10' : jQuery('#isbn10').val(),
            'isbn13' : jQuery('#isbn13').val(),
            'summary' : jQuery('#summary').val(),
            'publish_date' : jQuery('#publish_date').val(),
            'series.name' : jQuery('#series_name').val(),
            'series_id' : jQuery('#series_id').val(),
            'series_nr' : jQuery('#series_nr').val(),
            'in_library' : jQuery('#in_library').val(),
            'is_series' : function(){
                if (jQuery('#is_series_yes').is(':checked')) {
                    return 'True'
                } else {
                    return 'False'
                }
            }
        };
        jQuery.ajax({
            url: '/books/ajax_save/',
            type: 'POST',
            data : data,
            dataType: 'json',
            success: function(resp){
                console.log(resp)

            }
        })
    };

    jQuery(document).ready(function(){
        hideSeries();
        toggleSeries();
        jQuery('#save-book').on('click', function(){
            saveBook();
            jQuery('#add-popup').modal('hide');
        })
    });
</script>
</body>
</html>